import React, { useState, useEffect } from 'react';
import { Play, RotateCcw, Zap, Network, ArrowRight, Link } from 'lucide-react';

const CryptoGraphDemo = () => {
  const [activeDemo, setActiveDemo] = useState('nodes');
  const [isAnimating, setIsAnimating] = useState(false);
  const [animationStep, setAnimationStep] = useState(0);
  const [highlightedNodes, setHighlightedNodes] = useState([]);
  const [highlightedEdges, setHighlightedEdges] = useState([]);
  const [message, setMessage] = useState('');

  // Node positions - better spacing with individual colors
  const nodes = {
    alice: { x: 200, y: 150, label: 'Alice', balance: '2.5 BTC', emoji: 'üë©', color: '#ec4899', glow: '#f472b6' },
    bob: { x: 500, y: 150, label: 'Bob', balance: '1.0 BTC', emoji: 'üë®', color: '#3b82f6', glow: '#60a5fa' },
    carol: { x: 650, y: 350, label: 'Carol', balance: '0.5 BTC', emoji: 'üëß', color: '#8b5cf6', glow: '#a78bfa' },
    dave: { x: 350, y: 350, label: 'Dave', balance: '3.0 BTC', emoji: 'üßë', color: '#10b981', glow: '#34d399' },
    shop: { x: 200, y: 500, label: 'Coffee Shop', balance: '5.0 BTC', emoji: '‚òï', color: '#f59e0b', glow: '#fbbf24' }
  };

  // Edges (transactions)
  const edges = [
    { id: 0, from: 'dave', to: 'alice', amount: '1.5 BTC', label: '1.5', time: 'Week 1' },
    { id: 1, from: 'dave', to: 'bob', amount: '1.0 BTC', label: '1.0', time: 'Week 1' },
    { id: 2, from: 'alice', to: 'carol', amount: '0.3 BTC', label: '0.3', time: 'Week 2' },
    { id: 3, from: 'bob', to: 'carol', amount: '0.2 BTC', label: '0.2', time: 'Week 2' },
    { id: 4, from: 'carol', to: 'shop', amount: '0.5 BTC', label: '0.5', time: 'Week 3' }
  ];

  const resetAnimation = () => {
    setIsAnimating(false);
    setAnimationStep(0);
    setHighlightedNodes([]);
    setHighlightedEdges([]);
    setMessage('');
  };

  useEffect(() => {
    let timer;
    if (isAnimating) {
      timer = setTimeout(() => {
        if (activeDemo === 'nodes') {
          runNodesDemo();
        } else if (activeDemo === 'edges') {
          runEdgesDemo();
        } else if (activeDemo === 'traversal') {
          runTraversalDemo();
        } else if (activeDemo === 'connectivity') {
          runConnectivityDemo();
        }
      }, 1800);
    }
    return () => clearTimeout(timer);
  }, [isAnimating, animationStep, activeDemo]);

  const runNodesDemo = () => {
    const steps = [
      { nodes: ['alice'], msg: 'üîµ Node 1: Alice\'s Wallet (2.5 BTC balance)' },
      { nodes: ['alice', 'bob'], msg: 'üîµ Node 2: Bob\'s Wallet (1.0 BTC balance)' },
      { nodes: ['alice', 'bob', 'carol'], msg: 'üîµ Node 3: Carol\'s Wallet (0.5 BTC balance)' },
      { nodes: ['alice', 'bob', 'carol', 'dave'], msg: 'üîµ Node 4: Dave\'s Wallet (3.0 BTC balance)' },
      { nodes: ['alice', 'bob', 'carol', 'dave', 'shop'], msg: 'üîµ Node 5: Coffee Shop Wallet (5.0 BTC)' },
      { nodes: ['alice', 'bob', 'carol', 'dave', 'shop'], msg: '‚úÖ Total 5 NODES in this cryptocurrency network!' }
    ];

    if (animationStep < steps.length) {
      setHighlightedNodes(steps[animationStep].nodes);
      setMessage(steps[animationStep].msg);
      setAnimationStep(animationStep + 1);
    } else {
      setIsAnimating(false);
    }
  };

  const runEdgesDemo = () => {
    const steps = [
      { edges: [0], nodes: ['dave', 'alice'], msg: '‚û°Ô∏è Edge 1: Dave ‚Üí Alice (1.5 BTC transferred)' },
      { edges: [0, 1], nodes: ['dave', 'alice', 'bob'], msg: '‚û°Ô∏è Edge 2: Dave ‚Üí Bob (1.0 BTC transferred)' },
      { edges: [0, 1, 2], nodes: ['dave', 'alice', 'bob', 'carol'], msg: '‚û°Ô∏è Edge 3: Alice ‚Üí Carol (0.3 BTC transferred)' },
      { edges: [0, 1, 2, 3], nodes: ['dave', 'alice', 'bob', 'carol'], msg: '‚û°Ô∏è Edge 4: Bob ‚Üí Carol (0.2 BTC transferred)' },
      { edges: [0, 1, 2, 3, 4], nodes: ['dave', 'alice', 'bob', 'carol', 'shop'], msg: '‚û°Ô∏è Edge 5: Carol ‚Üí Shop (0.5 BTC for coffee!)' },
      { edges: [0, 1, 2, 3, 4], nodes: ['dave', 'alice', 'bob', 'carol', 'shop'], msg: '‚úÖ Total 5 EDGES showing money flow direction!' }
    ];

    if (animationStep < steps.length) {
      setHighlightedEdges(steps[animationStep].edges);
      setHighlightedNodes(steps[animationStep].nodes);
      setMessage(steps[animationStep].msg);
      setAnimationStep(animationStep + 1);
    } else {
      setIsAnimating(false);
    }
  };

  const runTraversalDemo = () => {
    const steps = [
      { nodes: ['carol'], edges: [], msg: 'üîç Start: Carol wants to buy coffee for 0.5 BTC' },
      { nodes: ['carol'], edges: [], msg: '‚ùì Question: Does Carol have 0.5 BTC?' },
      { nodes: ['carol', 'alice'], edges: [2], msg: '‚¨ÖÔ∏è Traverse Back: Found Alice sent 0.3 BTC to Carol' },
      { nodes: ['carol', 'alice', 'bob'], edges: [2, 3], msg: '‚¨ÖÔ∏è Traverse Back: Found Bob sent 0.2 BTC to Carol' },
      { nodes: ['carol', 'alice', 'bob'], edges: [2, 3], msg: 'üßÆ Calculate: 0.3 + 0.2 = 0.5 BTC' },
      { nodes: ['carol', 'shop'], edges: [4], msg: '‚úÖ Verified! Carol has 0.5 BTC. Transaction approved!' },
      { nodes: ['carol', 'shop'], edges: [4], msg: '‚òï Carol buys coffee successfully!' }
    ];

    if (animationStep < steps.length) {
      setHighlightedNodes(steps[animationStep].nodes);
      setHighlightedEdges(steps[animationStep].edges);
      setMessage(steps[animationStep].msg);
      setAnimationStep(animationStep + 1);
    } else {
      setIsAnimating(false);
    }
  };

  const runConnectivityDemo = () => {
    const steps = [
      { nodes: ['dave'], edges: [], msg: 'üü¢ Dave is connected to the network' },
      { nodes: ['dave', 'alice', 'bob'], edges: [0, 1], msg: 'üîó Dave connected to Alice and Bob (direct connections)' },
      { nodes: ['dave', 'alice', 'bob', 'carol'], edges: [0, 1, 2, 3], msg: 'üîó Carol connected through Alice and Bob' },
      { nodes: ['dave', 'alice', 'bob', 'carol', 'shop'], edges: [0, 1, 2, 3, 4], msg: 'üîó Shop connected through Carol' },
      { nodes: ['dave', 'alice', 'bob', 'carol', 'shop'], edges: [0, 1, 2, 3, 4], msg: 'üåê All nodes are CONNECTED! Path exists between any two wallets' },
      { nodes: ['dave', 'shop'], edges: [0, 2, 4], msg: 'üìç Example: Dave ‚Üí Alice ‚Üí Carol ‚Üí Shop (indirect path)' },
      { nodes: ['dave', 'alice', 'bob', 'carol', 'shop'], edges: [0, 1, 2, 3, 4], msg: '‚úÖ This is a CONNECTED GRAPH - cryptocurrency network is secure!' }
    ];

    if (animationStep < steps.length) {
      setHighlightedNodes(steps[animationStep].nodes);
      setHighlightedEdges(steps[animationStep].edges);
      setMessage(steps[animationStep].msg);
      setAnimationStep(animationStep + 1);
    } else {
      setIsAnimating(false);
    }
  };

  const getEdgePath = (edge) => {
    const from = nodes[edge.from];
    const to = nodes[edge.to];
    return `M ${from.x} ${from.y} L ${to.x} ${to.y}`;
  };

  const getEdgeMidpoint = (edge) => {
    const from = nodes[edge.from];
    const to = nodes[edge.to];
    return {
      x: (from.x + to.x) / 2,
      y: (from.y + to.y) / 2
    };
  };

  const startAnimation = () => {
    resetAnimation();
    setIsAnimating(true);
  };

  return (
    <div className="w-full min-h-screen bg-gradient-to-br from-indigo-950 via-purple-950 to-pink-950 p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400 mb-3">
            Cryptocurrency Graph Theory
          </h1>
          <p className="text-cyan-200 text-xl">Interactive Visualization of Blockchain Networks</p>
        </div>

        {/* Demo Selection Buttons */}
        <div className="grid grid-cols-4 gap-4 mb-8">
          <button
            onClick={() => { setActiveDemo('nodes'); resetAnimation(); }}
            className={`p-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 ${
              activeDemo === 'nodes' 
                ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-2xl shadow-cyan-500/50' 
                : 'bg-slate-800/50 text-cyan-300 hover:bg-slate-700/50'
            }`}
          >
            <Network className="mx-auto mb-2" size={32} />
            NODES
          </button>
          <button
            onClick={() => { setActiveDemo('edges'); resetAnimation(); }}
            className={`p-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 ${
              activeDemo === 'edges' 
                ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-2xl shadow-green-500/50' 
                : 'bg-slate-800/50 text-green-300 hover:bg-slate-700/50'
            }`}
          >
            <ArrowRight className="mx-auto mb-2" size={32} />
            EDGES
          </button>
          <button
            onClick={() => { setActiveDemo('traversal'); resetAnimation(); }}
            className={`p-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 ${
              activeDemo === 'traversal' 
                ? 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-2xl shadow-yellow-500/50' 
                : 'bg-slate-800/50 text-yellow-300 hover:bg-slate-700/50'
            }`}
          >
            <Zap className="mx-auto mb-2" size={32} />
            TRAVERSAL
          </button>
          <button
            onClick={() => { setActiveDemo('connectivity'); resetAnimation(); }}
            className={`p-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 ${
              activeDemo === 'connectivity' 
                ? 'bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-2xl shadow-pink-500/50' 
                : 'bg-slate-800/50 text-pink-300 hover:bg-slate-700/50'
            }`}
          >
            <Link className="mx-auto mb-2" size={32} />
            CONNECTIVITY
          </button>
        </div>

        {/* Control Buttons */}
        <div className="flex justify-center gap-4 mb-8">
          <button
            onClick={startAnimation}
            disabled={isAnimating}
            className="px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 disabled:from-gray-600 disabled:to-gray-700 text-white rounded-xl font-bold text-lg flex items-center gap-3 transition-all transform hover:scale-105 shadow-lg disabled:shadow-none"
          >
            <Play size={24} />
            START DEMO
          </button>
          <button
            onClick={resetAnimation}
            className="px-8 py-4 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white rounded-xl font-bold text-lg flex items-center gap-3 transition-all transform hover:scale-105 shadow-lg"
          >
            <RotateCcw size={24} />
            RESET
          </button>
        </div>

        {/* Message Display */}
        {message && (
          <div className="mb-6 p-6 bg-gradient-to-r from-purple-900/80 to-pink-900/80 rounded-xl border-2 border-cyan-400 shadow-2xl shadow-cyan-500/30">
            <p className="text-2xl font-bold text-center text-cyan-100">{message}</p>
          </div>
        )}

        {/* Main Graph Visualization */}
        <div className="bg-slate-900/80 backdrop-blur rounded-2xl p-8 shadow-2xl border-2 border-purple-500/30">
          <svg width="100%" height="650" viewBox="0 0 850 650" className="bg-slate-950/50 rounded-xl">
            {/* Draw Edges */}
            {edges.map((edge) => {
              const midpoint = getEdgeMidpoint(edge);
              const isHighlighted = highlightedEdges.includes(edge.id);
              return (
                <g key={edge.id}>
                  <defs>
                    <marker
                      id={`arrow-${edge.id}`}
                      markerWidth="12"
                      markerHeight="12"
                      refX="10"
                      refY="4"
                      orient="auto"
                    >
                      <polygon 
                        points="0 0, 12 4, 0 8" 
                        fill={isHighlighted ? '#22d3ee' : '#6366f1'} 
                      />
                    </marker>
                  </defs>
                  <path
                    d={getEdgePath(edge)}
                    stroke={isHighlighted ? '#22d3ee' : '#6366f1'}
                    strokeWidth={isHighlighted ? '5' : '3'}
                    fill="none"
                    markerEnd={`url(#arrow-${edge.id})`}
                    className="transition-all duration-700"
                    opacity={isHighlighted ? '1' : '0.5'}
                  />
                  <text
                    x={midpoint.x}
                    y={midpoint.y - 15}
                    fill={isHighlighted ? '#22d3ee' : '#c4b5fd'}
                    fontSize="16"
                    fontWeight="bold"
                    textAnchor="middle"
                    className="transition-all duration-700"
                  >
                    {edge.label} BTC
                  </text>
                  <text
                    x={midpoint.x}
                    y={midpoint.y}
                    fill={isHighlighted ? '#67e8f9' : '#a78bfa'}
                    fontSize="12"
                    textAnchor="middle"
                  >
                    {edge.time}
                  </text>
                </g>
              );
            })}

            {/* Draw Nodes */}
            {Object.entries(nodes).map(([key, node]) => {
              const isHighlighted = highlightedNodes.includes(key);
              return (
                <g key={key}>
                  {/* Glow effect for highlighted nodes */}
                  {isHighlighted && (
                    <circle
                      cx={node.x}
                      cy={node.y}
                      r="60"
                      fill="none"
                      stroke="#22d3ee"
                      strokeWidth="4"
                      opacity="0.3"
                      className="animate-pulse"
                    />
                  )}
                  <circle
                    cx={node.x}
                    cy={node.y}
                    r={isHighlighted ? '50' : '45'}
                    fill={isHighlighted ? 'url(#gradient-active)' : 'url(#gradient-normal)'}
                    stroke={isHighlighted ? '#22d3ee' : '#8b5cf6'}
                    strokeWidth={isHighlighted ? '4' : '2'}
                    className="transition-all duration-700"
                  />
                  <text
                    x={node.x}
                    y={node.y - 10}
                    fill="white"
                    fontSize="24"
                    textAnchor="middle"
                  >
                    {node.emoji}
                  </text>
                  <text
                    x={node.x}
                    y={node.y + 10}
                    fill="white"
                    fontSize="14"
                    fontWeight="bold"
                    textAnchor="middle"
                  >
                    {node.label}
                  </text>
                  <text
                    x={node.x}
                    y={node.y + 28}
                    fill="#fbbf24"
                    fontSize="12"
                    fontWeight="bold"
                    textAnchor="middle"
                  >
                    {node.balance}
                  </text>
                </g>
              );
            })}

            {/* Gradient definitions */}
            <defs>
              <linearGradient id="gradient-normal" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stopColor="#7c3aed" />
                <stop offset="100%" stopColor="#a855f7" />
              </linearGradient>
              <linearGradient id="gradient-active" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stopColor="#06b6d4" />
                <stop offset="100%" stopColor="#22d3ee" />
              </linearGradient>
            </defs>
          </svg>
        </div>

        {/* Concept Explanation Cards */}
        <div className="mt-8 grid grid-cols-4 gap-4">
          <div className="bg-gradient-to-br from-cyan-900/50 to-blue-900/50 p-5 rounded-xl border-2 border-cyan-500/30">
            <h4 className="text-cyan-300 font-bold text-lg mb-2 flex items-center gap-2">
              <Network size={20} /> NODES
            </h4>
            <p className="text-cyan-100 text-sm">Wallets/entities in the network represented as circles</p>
          </div>
          <div className="bg-gradient-to-br from-green-900/50 to-emerald-900/50 p-5 rounded-xl border-2 border-green-500/30">
            <h4 className="text-green-300 font-bold text-lg mb-2 flex items-center gap-2">
              <ArrowRight size={20} /> EDGES
            </h4>
            <p className="text-green-100 text-sm">Transactions showing direction and amount of Bitcoin flow</p>
          </div>
          <div className="bg-gradient-to-br from-yellow-900/50 to-orange-900/50 p-5 rounded-xl border-2 border-yellow-500/30">
            <h4 className="text-yellow-300 font-bold text-lg mb-2 flex items-center gap-2">
              <Zap size={20} /> TRAVERSAL
            </h4>
            <p className="text-yellow-100 text-sm">Following paths backward to verify balances and transactions</p>
          </div>
          <div className="bg-gradient-to-br from-pink-900/50 to-rose-900/50 p-5 rounded-xl border-2 border-pink-500/30">
            <h4 className="text-pink-300 font-bold text-lg mb-2 flex items-center gap-2">
              <Link size={20} /> CONNECTIVITY
            </h4>
            <p className="text-pink-100 text-sm">How all wallets are linked through transaction paths</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CryptoGraphDemo;